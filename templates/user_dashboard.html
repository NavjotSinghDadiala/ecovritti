{% extends "base_user.html" %}
{% block content %}
<div class="dashboard-hero">
  <div class="dashboard-hero-icon">
    <span class="material-icons" style="font-size:3rem;color:#22c55e;">navi</span>
  </div>
  <div>
    <h1 class="dashboard-title">Resident Dashboard</h1>
    <p class="dashboard-sub">Track your rewards, progress, and segregation history</p>
  </div>
  <div class="dashboard-kpis">
    <div class="kpi-card">
      <div class="kpi-label">Reward Points</div>
      <div class="kpi-value" id="scoreValue">0 pts</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Level</div>
      <div class="kpi-value" id="levelValue">1</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Rank</div>
      <div class="kpi-value" id="rankValue">-</div>
    </div>
  </div>
</div>
<main class="dashboard-main grid grid-2">
  <section class="card dashboard-section">
    <div class="section-title"><span class="material-icons kpi-icon">qr_code</span> Profile & QR <span class="badge success" id="residentIdBadge"></span></div>
    <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:24px;">
      {% if user.qr_code_path %}
        <img src="{{ url_for('static', filename='qrcodes/resident_' ~ user.id ~ '.png') }}" width="160" height="160" style="border-radius:16px; box-shadow:0 2px 12px rgba(34,197,94,0.10);" alt="Resident QR">
      {% else %}
        <div id="qr" style="border-radius:16px; box-shadow:0 2px 12px rgba(34,197,94,0.10);"></div>
      {% endif %}
      <p style="font-size:14px; color:#16a34a; margin:0;">Your Unique QR Code</p>
    </div>
  </section>
  <section class="card dashboard-section">
    <div class="section-title"><span class="material-icons kpi-icon">history</span> Reward History <span class="badge">Updates</span></div>
    <table class="table" id="rewardTable">
      <thead><tr><th>Date</th><th>Reward</th><th>Note</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
  <section class="card dashboard-section">
    <div class="section-title"><span class="material-icons kpi-icon">leaderboard</span> Society Leaderboard <span class="badge">Top performers</span></div>
    <div class="leaderboard-card">
      <table class="table" id="leaderboard">
        <thead><tr><th>#</th><th>Name</th><th>Flat</th><th>Score</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>
<script src="https://fonts.googleapis.com/icon?family=Material+Icons"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // If fallback QR div exists, generate a QR using server-side values
    const qrDiv = document.getElementById("qr");
    if (qrDiv) {
      new QRCode(qrDiv, {
        text: "{{ user.id }}",
        width: 160,
        height: 160,
        colorDark: "#16a34a",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }
    const rewards = [
      { date: "2025-09-20", reward: "+20 pts", note: "Proper segregation" },
      { date: "2025-09-15", reward: "+10 pts", note: "Organic waste recycled" }
    ];
    const rewardTable = document.querySelector("#rewardTable tbody");
    rewards.forEach(r => {
      const row = `<tr><td>${r.date}</td><td>${r.reward}</td><td>${r.note}</td></tr>`;
      rewardTable.insertAdjacentHTML("beforeend", row);
    });
    let totalPoints = rewards.reduce((sum, r) => sum + parseInt(r.reward), 0);
    document.getElementById("scoreValue").textContent = totalPoints + " pts";
    let level = Math.floor(totalPoints / 50) + 1;
    document.getElementById("levelValue").textContent = level;
    // Example mock leaderboard
    const leaderboard = [
      { name: "{{ user.username }}", flat: "{{ user.room_no }}", score: totalPoints + " pts" },
      { name: "Neha Sharma", flat: "B-203", score: "140 pts" },
      { name: "Ravi Patel", flat: "A-305", score: "135 pts" }
    ];
    const leaderboardTable = document.querySelector("#leaderboard tbody");
    leaderboard.forEach((p, i) => {
      const row = `<tr><td>${i + 1}</td><td>${p.name}</td><td>${p.flat}</td><td>${p.score}</td></tr>`;
      leaderboardTable.insertAdjacentHTML("beforeend", row);
      if (p.name === "{{ user.username }}") document.getElementById("rankValue").textContent = i + 1;
    });
  });
</script>
{% endblock %}